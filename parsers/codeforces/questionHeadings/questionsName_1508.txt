D2. Seating Arrangements (hard version)