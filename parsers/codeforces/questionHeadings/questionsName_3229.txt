D2. Optimal Subsequences (Hard Version)