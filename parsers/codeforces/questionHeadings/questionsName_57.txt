G2. Magic Triples (Hard Version)