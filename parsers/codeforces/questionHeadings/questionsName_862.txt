D2. Permutation Weight (Hard Version)